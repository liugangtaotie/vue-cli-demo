<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <div id="app">
    <input type="text" v-model="pusa.name" />
    <div>{{pusa.name}}</div>
    <div>{{pusa.age}}</div>
  </div>

  <!-- <script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.12/vue.js"></script> -->
  <script src="./mvvm.js"></script>

  <script>
    // const vm = new Vue({
    //   el: '#app',
    //   data: {
    //     pusa: {
    //       name: '菩萨',
    //       age: 400
    //     }
    //   }
    // })

    const ajaxPromise = function (url) {
      return new Promise(function (resolve, reject) {
        setTimeout(() => {
          console.log('1000', url)
          resolve()
        }, 1000)
      })
    }

    const urls = ['url___A',
      'url___B',
      'url___C',
      'url___D',
      'url___E',
      'url___F',
      'url___G',
    ];

    multiRequest(urls, 3)

    function multiRequest(urls = [], maxNum) {
      // 请求总数量
      const len = urls.length;
      // 根据请求数量创建一个数组来保存请求的结果
      const result = new Array(len).fill(false);

      // 当前完成的数量
      let count = 0;

      return new Promise((resolve, reject) => {
        // 请求maxNum个
        while (count < maxNum) {
          next();
        }

        console.info('1111', result)


        function next() {
          let current = count++;
          // 处理边界条件
          if (current >= len) {
            // 请求全部完成就将promise置为成功状态, 然后将result作为promise值返回
            !result.includes(false) && resolve(result);
            console.info('222', result)
            return;
          }
          const url = urls[current];
          console.log(`开始 ${current}`, new Date().toLocaleString());
          ajaxPromise(url)
            .then((res) => {
              // 保存请求结果
              result[current] = res;
              console.log(`完成 ${current}`, new Date().toLocaleString());
              // 请求没有全部完成, 就递归
              if (current < len) {
                next();
              }
            })
            .catch((err) => {
              console.log(`结束 ${current}`, new Date().toLocaleString());
              result[current] = err;
              // 请求没有全部完成, 就递归
              if (current < len) {
                next();
              }
            });
        }
      });
    }
  </script>

</body>

</html>
